generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String           @id @default(cuid())
  email          String           @unique
  name           String?
  image          String?
  role           Role             @default(STUDENT)
  locale         String           @default("ru")
  passwordHash   String?
  passwordTail   String?
  firstName      String?
  lastName       String?
  phone          String?
  emailVerified  DateTime?
  enrollments    Enrollment[]
  submissions    Submission[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  Payment        Payment[]
  LessonProgress LessonProgress[]
  tokens         VerificationToken[]
}

model VerificationToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([expiresAt])
}

model Course {
  id          String       @id @default(cuid())
  slug        String       @unique
  title       Json
  description Json
  priceBasic      Int          @default(200000)
  pricePro        Int          @default(400000)
  priceDeluxe     Int          @default(800000)
  lessons     Lesson[]
  level       String       @default("Beginner")
  published   Boolean      @default(false)
  visible     Boolean      @default(true) 
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  Enrollment  Enrollment[]
  Payment     Payment[]
}

model Lesson {
  id             String           @id @default(cuid())
  courseId       String
  slug           String
  title          Json
  content        Json

  hasVideo       Boolean          @default(true)
  hasConspect    Boolean          @default(false)
  hasTest        Boolean          @default(false)

  zoomMeetingId  String?
  order          Int              @default(0)
  course         Course           @relation(fields: [courseId], references: [id])
  Assignment     Assignment[]
  LessonProgress LessonProgress[]
}

model Enrollment {
  id        String           @id @default(cuid())
  userId    String
  courseId  String
  status    EnrollmentStatus @default(ACTIVE)
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id])
  course    Course           @relation(fields: [courseId], references: [id])
  plan Plan?
}

model Assignment {
  id          String       @id @default(cuid())
  lessonId    String
  title       Json
  prompt      Json
  answerKey   Json?
  lesson      Lesson       @relation(fields: [lessonId], references: [id])
  submissions Submission[]
}

model Submission {
  id           String     @id @default(cuid())
  assignmentId String
  userId       String
  answer       Json
  grade        Int?
  createdAt    DateTime   @default(now())
  assignment   Assignment @relation(fields: [assignmentId], references: [id])
  user         User       @relation(fields: [userId], references: [id])
}

model Payment {
  id          String   @id @default(cuid())
  userId      String
  courseId    String
  provider    String
  providerRef String
  amountCents Int
  currency    String
  status      String
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])
  course      Course   @relation(fields: [courseId], references: [id])
}

model LessonProgress {
  id        String   @id @default(cuid())
  userId    String
  lessonId  String
  watched   Boolean  @default(false)
  passed    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])
  lesson    Lesson   @relation(fields: [lessonId], references: [id])

  @@unique([userId, lessonId])
}

enum Role {
  ADMIN
  MENTOR
  STUDENT
}

enum Plan {
  FREE
  BASIC
  PRO
  DELUXE
}

enum EnrollmentStatus {
  ACTIVE
  CANCELED
}
